<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digit Classifier with TensorFlowJS</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1320;
      --accent:#7c3aed;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1220 0%, #0f1724 60%);font-family:Inter,InterVar,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#e6eef8}
    .wrap{max-width:980px;margin:36px auto;padding:26px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;box-shadow:0 6px 18px rgba(124,58,237,0.18)}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 18px;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:22px}
    .panel{background:var(--card);padding:16px;border-radius:12px;box-shadow: inset 0 1px 0 rgba(255,255,255,0.02)}
    .canvas-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    canvas#draw{border-radius:10px;background:#000;width:360px;height:360px;touch-action:none}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);color:white;border:none;box-shadow:0 8px 20px rgba(12,18,40,0.45)}
    .small{font-size:13px;padding:6px 10px}
    .info{font-size:13px;color:var(--muted);margin-top:8px}
    .right-col{display:flex;flex-direction:column;gap:12px}
    .preview-row{display:flex;gap:12px;align-items:center}
    .mini-canvas{width:140px;height:140px;border-radius:8px;background:#000;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    .pred-card{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
    .pred-title{font-size:14px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .pred-value{font-size:44px;font-weight:800;margin:4px 0;color:white}
    .bars{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .bar{display:flex;align-items:center;gap:10px}
    .bar .label{width:24px;text-align:right;color:var(--muted);font-size:13px}
    .bar .track{flex:1;height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .bar .fill{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,var(--accent),#06b6d4)}
    footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
    .status{font-size:13px;color:var(--muted);margin-left:auto}
    @media(max-width:880px){.grid{grid-template-columns:1fr;}.canvas-wrap canvas{width:100%;height:300px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AAY</div>
      <div style="flex:1">
        <h1>Neural Network Digit Classifier</h1>
        <p class="lead">Gambar angka di kiri. Model neural network yang bisa memprediksi angka tulisan tangan MNIST.</p>
      </div>
      <div class="status" id="status">Memuat model...</div>
    </header>

    <section class="grid" style="margin-top:18px">
      <div class="panel">
        <div class="canvas-wrap">
          <canvas id="draw" width="280" height="280"></canvas>
          <div style="display:flex;justify-content:center;width:100%" class="controls">
            <button id="clearBtn" class="btn small">Clear</button>
            <button id="invertBtn" class="btn small">Toggle Bg</button>
            <button id="predictBtn" class="btn primary small">Check Digit</button>
            <button id="saveBtn" class="btn small">Save PNG</button>
          </div>
          <div class="info">Tip: gunakan mouse/pen/jari untuk menulis. Buat angka tebal agar prediksi lebih akurat.</div>
        </div>
      </div>

      <div class="panel right-col">
        <div class="preview-row">
          <div>
            <div style="font-size:13px;color:var(--muted)">Input (scaled preview)</div>
            <canvas id="mini" class="mini-canvas" width="140" height="140"></canvas>
          </div>
          <div style="flex:1">
            <div class="pred-card">
              <div class="pred-title">Prediction</div>
              <div class="pred-value" id="predLabel">-</div>

              <div class="bars" id="bars">
                <!-- bars inserted here -->
              </div>
            </div>
            <div style="margin-top:10px;font-size:13px;color:var(--muted)">Model: <b>pretrained MNIST CNN (TFJS)</b></div>
          </div>
        </div>

        <div style="padding:12px;border-radius:8px;background:transparent">
          <div style="font-size:13px;color:var(--muted)">Debug / Info</div>
          <pre id="debug" style="margin:6px 0 0;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);color:#cfe9ff;font-size:12px;max-height:120px;overflow:auto">Ready.</pre>
        </div>
      </div>
    </section>

    <footer>Built with ❤️ & TensorFlow.js — coba gambar angka lain untuk lihat hasilnya</footer>
  </div>

<script>
(async ()=>{

  // Config: model URL (pretrained TFJS MNIST model)
  const MODEL_URL = 'https://storage.googleapis.com/tfjs-models/tfjs/mnist/model.json';
  // NOTE: jika URL tidak tersedia, periksa console / status.

  const statusEl = document.getElementById('status');
  const debug = (s)=>{ document.getElementById('debug').textContent = s; console.log(s); };
  let model=null;

  async function loadModel(){
    try{
      statusEl.textContent = 'Memuat model...';
      model = await tf.loadLayersModel(MODEL_URL);
      statusEl.textContent = 'Model siap ✅';
      debug('Model loaded: ' + MODEL_URL);
    }catch(err){
      statusEl.textContent = 'Gagal memuat model';
      debug('Error loading model: ' + err.toString() + '\\nJika model gagal, periksa koneksi atau ganti MODEL_URL.');
      console.error(err);
    }
  }

  await loadModel();

  // Canvas setup
  const canvas = document.getElementById('draw');
  const ctx = canvas.getContext('2d');
  let drawing=false;
  let bgBlack=true;

  // initialize canvas black bg
  function resetCanvas(){
    ctx.fillStyle = bgBlack ? '#000' : '#fff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.lineCap='round';
    ctx.lineJoin='round';
    ctx.strokeStyle = bgBlack ? '#fff' : '#000';
    ctx.lineWidth = 18;
  }
  resetCanvas();

  // touch/mouse drawing
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches.length) e = e.touches[0];
    return {x: (e.clientX - rect.left) * (canvas.width/rect.width), y: (e.clientY - rect.top) * (canvas.height/rect.height)};
  }

  canvas.addEventListener('pointerdown', (e)=>{ drawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
  canvas.addEventListener('pointermove', (e)=>{ if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
  window.addEventListener('pointerup', ()=>{ drawing=false; });

  // Buttons
  document.getElementById('clearBtn').addEventListener('click', ()=>{ resetCanvas(); document.getElementById('predLabel').textContent='-'; updateMini(); updateBars(new Array(10).fill(0)); });
  document.getElementById('invertBtn').addEventListener('click', ()=>{ bgBlack = !bgBlack; resetCanvas(); updateMini(); });
  document.getElementById('saveBtn').addEventListener('click', ()=>{ const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = 'digit.png'; a.click(); });
  document.getElementById('predictBtn').addEventListener('click', predict);

  // mini preview
  const mini = document.getElementById('mini');
  const mctx = mini.getContext('2d');
  function updateMini(){
    // draw scaled canvas to mini
    mctx.fillStyle = bgBlack? '#000':'#fff';
    mctx.fillRect(0,0,mini.width,mini.height);
    mctx.drawImage(canvas, 0,0, mini.width, mini.height);
  }
  updateMini();

  // Build bars UI
  const barsEl = document.getElementById('bars');
  function createBars(){
    barsEl.innerHTML = '';
    for(let i=0;i<10;i++){
      const wrap = document.createElement('div'); wrap.className='bar';
      const label = document.createElement('div'); label.className='label'; label.textContent = i;
      const track = document.createElement('div'); track.className='track';
      const fill = document.createElement('div'); fill.className='fill'; fill.style.width='0%';
      track.appendChild(fill);
      wrap.appendChild(label); wrap.appendChild(track);
      barsEl.appendChild(wrap);
    }
  }
  createBars();

  function updateBars(probs){
    const fills = document.querySelectorAll('.fill');
    for(let i=0;i<10;i++){
      const pct = Math.round((probs[i]||0)*100);
      fills[i].style.width = pct + '%';
    }
  }

  // Preprocess & predict
  async function predict(){
    if(!model){ alert('Model belum siap. Cek status di kanan atas.'); return; }
    statusEl.textContent = 'Memprediksi...';
    try{
      // read pixels as tensor
      const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      // tf.browser.fromPixels gives shape [h,w,3]
      let img = tf.browser.fromPixels(imgData).mean(2); // grayscale [h,w]
      img = img.expandDims(-1); // [h,w,1]
      // Resize to 28x28
      img = tf.image.resizeBilinear(img, [28,28], true);
      // Convert to float32 and normalize 0..1
      // We want model to see white stroke on black background as MNIST: white strokes ~1.
      // tf.fromPixels produced 0..255 where stroke color is 255 for stroke color. If background is black, stroke=255.
      // If user toggled invert, background may be white. So normalize by inverting when needed:
      let tensor = img.toFloat().div(255.0); // 0..1
      if(!bgBlack){
        // if background is white and strokes are black, invert to mimic MNIST
        tensor = tf.sub(1.0, tensor);
      }
      // Some models expect values centered; this pretrained expects shape [1,28,28,1] scaled 0..1.
      tensor = tensor.reshape([1,28,28,1]);
      // Run model
      const logits = model.predict(tensor);
      const probsTensor = tf.softmax(logits);
      const probs = await probsTensor.data();
      const arr = Array.from(probs);
      const maxIndex = arr.indexOf(Math.max(...arr));
      document.getElementById('predLabel').textContent = maxIndex;
      updateBars(arr);
      debug('Probs: ' + arr.map(x=>x.toFixed(3)).join(', '));
      // Update mini preview with processed 28x28 (visualize what model saw)
      const vis = await tf.tidy(()=>{
        // get first example, reshape 28x28
        const p = tensor.reshape([28,28]);
        // scale back to 0..255
        const scaled = p.mul(255).toInt();
        return tf.browser.toPixels(scaled, mini);
      });
    }catch(err){
      console.error(err);
      debug('Error during predict: ' + err.toString());
      alert('Terjadi kesalahan saat prediksi. Lihat console/debug.');
    }finally{
      statusEl.textContent = 'Model siap ✅';
      tf.engine().disposeVariables(); // free ops if any
    }
  }

  // Keep mini in sync with drawing
  let lastDraw = Date.now();
  function autoUpdateMini(){
    const now = Date.now();
    if(now - lastDraw > 50){
      updateMini();
      lastDraw = now;
    }
    requestAnimationFrame(autoUpdateMini);
  }
  autoUpdateMini();

  // initial bars zero
  updateBars(new Array(10).fill(0));

  // optional: allow predict by pressing Enter key
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') predict(); });

})();
</script>
</body>
                                                                </html>
